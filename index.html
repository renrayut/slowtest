<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Speed Test</title>
    <!-- Tailwind CSS CDN for quick and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean, modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basic styling for the body and container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 1rem; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Soft shadow */
            padding: 2rem;
            width: 100%;
            max-width: 500px; /* Max width for larger screens */
            text-align: center;
        }
        /* Styling for the speed display */
        .speed-display {
            font-size: 3rem; /* Large font size for speed number */
            font-weight: 700; /* Bold */
            color: #1a202c; /* Dark text color */
            margin-bottom: 1rem;
        }
        .unit {
            font-size: 1.5rem; /* Smaller font size for units (Mbps) */
            font-weight: 600;
            color: #4a5568; /* Slightly lighter text color for units */
        }
        /* Styling for status messages */
        .status-message {
            font-size: 1.125rem;
            color: #4a5568;
            margin-top: 1rem;
        }
        /* Styling for the button */
        .button {
            background-color: #4c51bf; /* Primary blue color */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease; /* Smooth hover effect */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Button shadow */
            border: none; /* Remove default button border */
        }
        .button:hover {
            background-color: #5a61d1; /* Darker blue on hover */
        }
        .button:disabled {
            background-color: #a0aec0; /* Gray when disabled */
            cursor: not-allowed;
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light gray border */
            border-top: 4px solid #4c51bf; /* Blue top border for spinning effect */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite; /* Spin animation */
            margin: 1rem auto;
            display: none; /* Hidden by default, shown when testing */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Internet Speed Test</h1>
        <div id="speedDisplay" class="speed-display">0.00 <span class="unit">Mbps</span></div>
        <div id="statusMessage" class="status-message">Click 'Start Test' to begin.</div>
        <div id="loadingSpinner" class="loading-spinner"></div>
        <button id="startButton" class="button mt-6">Start Test</button>
    </div>

    <script>
        // Get references to DOM elements
        const speedDisplay = document.getElementById('speedDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const startButton = document.getElementById('startButton');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // --- Configuration ---
        // IMPORTANT: These URLs must point to your running Node.js backend.
        // If your Node.js server is on a different IP or port, update these.
        const DOWNLOAD_TEST_URL = 'https://slowtest-five.vercel.app/download-test';
        const UPLOAD_TEST_URL = 'https://slowtest-five.vercel.app/upload-test';
        // Increased file sizes for better accuracy on high-speed connections
        const DOWNLOAD_FILE_SIZE_MB = 100; // Expected size of dummy file to download (in MB)
        const UPLOAD_FILE_SIZE_MB = 50; // Size of dummy data to upload (in MB)

        // --- Helper Functions for UI Updates ---

        /**
         * Updates the speed display with the given value and unit.
         * @param {number} speed - The calculated speed.
         * @param {string} unit - The unit of speed (e.g., 'Mbps').
         */
        function displaySpeed(speed, unit = 'Mbps') {
            speedDisplay.innerHTML = `${speed.toFixed(2)} <span class="unit">${unit}</span>`;
        }

        /**
         * Updates the status message displayed to the user.
         * @param {string} message - The message to display.
         */
        function setStatus(message) {
            statusMessage.textContent = message;
        }

        /**
         * Enables the start button and hides the loading spinner.
         */
        function enableButton() {
            startButton.disabled = false;
            startButton.textContent = 'Start Test';
            loadingSpinner.style.display = 'none';
        }

        /**
         * Disables the start button and shows the loading spinner.
         */
        function disableButton() {
            startButton.disabled = true;
            startButton.textContent = 'Testing...';
            loadingSpinner.style.display = 'block';
        }

        /**
         * Displays an error message and resets the UI.
         * @param {string} message - The error message to show.
         */
        function showErrorMessage(message) {
            setStatus(`Error: ${message}`);
            displaySpeed(0); // Reset speed display
            enableButton();
        }

        // --- Speed Test Logic ---

        /**
         * Performs the download speed test.
         * Fetches a large dummy file from the server and calculates download speed.
         * @returns {Promise<number>} - A promise that resolves with the download speed in Mbps.
         */
        async function startDownloadTest() {
            setStatus('Starting download test...');
            const startTime = performance.now(); // Record start time for accurate measurement

            try {
                // Fetch a large dummy file from the server.
                // Adding a unique query parameter to prevent browser caching.
                const response = await fetch(DOWNLOAD_TEST_URL + `?size=${DOWNLOAD_FILE_SIZE_MB}&nocache=${Date.now()}`, {
                    cache: 'no-store' // Explicitly tell browser not to cache
                });

                // Check if the HTTP response was successful
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                // Read the response body to ensure all data is received.
                // This is crucial for accurate measurement, as `response.blob()` or `response.arrayBuffer()`
                // might resolve before the entire data stream is consumed.
                const reader = response.body.getReader();
                let receivedLength = 0;
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break; // All data has been read
                    receivedLength += value.length; // Accumulate received bytes
                }

                const endTime = performance.now(); // Record end time
                const durationSeconds = (endTime - startTime) / 1000; // Calculate duration in seconds

                // Calculate speed: (bytes * 8 bits/byte) / (1,000,000 bits/Mbps) / seconds
                // Using 1,000,000 for Mbps (Megabits per second) as is common in networking.
                const downloadedBits = receivedLength * 8;
                const speedMbps = (downloadedBits / (1000 * 1000)) / durationSeconds;

                setStatus('Download test complete.');
                return speedMbps;

            } catch (error) {
                console.error('Download test failed:', error);
                throw new Error('Download test failed. Ensure your Node.js server is running and accessible.');
            }
        }

        /**
         * Performs the upload speed test.
         * Creates a large dummy data blob and uploads it to the server.
         * @returns {Promise<number>} - A promise that resolves with the upload speed in Mbps.
         */
        async function startUploadTest() {
            setStatus('Starting upload test...');
            const startTime = performance.now(); // Record start time

            try {
                // Create a dummy blob of data for upload.
                // `ArrayBuffer` is efficient for large binary data.
                const uploadData = new Blob([new ArrayBuffer(UPLOAD_FILE_SIZE_MB * 1024 * 1024)], { type: 'application/octet-stream' });

                const response = await fetch(UPLOAD_TEST_URL, {
                    method: 'POST',
                    body: uploadData, // Send the blob as the request body
                    headers: {
                        'Content-Type': 'application/octet-stream',
                        'Content-Length': uploadData.size // Explicitly set content-length for server to know expected size
                    },
                    cache: 'no-store' // Prevent caching
                });

                // Check if the HTTP response was successful
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const endTime = performance.now(); // Record end time
                const durationSeconds = (endTime - startTime) / 1000; // Calculate duration in seconds

                // Calculate speed: (bytes * 8 bits/byte) / (1,000,000 bits/Mbps) / seconds
                // Using 1,000,000 for Mbps (Megabits per second) as is common in networking.
                const uploadedBits = uploadData.size * 8;
                const speedMbps = (uploadedBits / (1000 * 1000)) / durationSeconds;

                setStatus('Upload test complete.');
                return speedMbps;

            } catch (error) {
                console.error('Upload test failed:', error);
                throw new Error('Upload test failed. Ensure your Node.js server is running and accessible.');
            }
        }

        /**
         * Orchestrates the full speed test (download then upload).
         */
        async function runSpeedTest() {
            disableButton(); // Disable button and show spinner during test
            displaySpeed(0); // Reset speed display

            try {
                // --- Run Download Test ---
                const downloadSpeed = await startDownloadTest();
                displaySpeed(downloadSpeed); // Display download speed immediately
                setStatus(`Download: ${downloadSpeed.toFixed(2)} Mbps`);

                // Add a small delay for better user experience before starting upload
                await new Promise(resolve => setTimeout(resolve, 1000));

                // --- Run Upload Test ---
                const uploadSpeed = await startUploadTest();
                // Display upload speed as the final primary result, or show both
                displaySpeed(uploadSpeed);
                setStatus(`Download: ${downloadSpeed.toFixed(2)} Mbps | Upload: ${uploadSpeed.toFixed(2)} Mbps`);

            } catch (error) {
                showErrorMessage(error.message); // Handle any errors during the test
            } finally {
                enableButton(); // Re-enable button and hide spinner after test completes or fails
            }
        }

        // --- Event Listener ---
        startButton.addEventListener('click', runSpeedTest);

        // Initial status message when the page loads
        setStatus('Ready to test your internet speed!');
    </script>
</body>
</html>
